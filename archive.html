<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archive</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:      #0a0a0c;
      --surface: #111116;
      --surface2:#17171e;
      --surface3:#1e1e27;
      --border:  #ffffff0f;
      --border2: #ffffff18;
      --border3: #ffffff28;
      --dim:     #4a4a62;
      --mid:     #7070a0;
      --muted:   #9898b8;
      --text:    #d8d8ec;
      --bright:  #f0f0f8;
      --accent:  #a78bfa;
      --accent2: #8b68f0;
      --accent3: #c4b5fd;
      --red:     #f87171;
      --green:   #4ade80;
      --r:       6px;
      --rm:      10px;
      --rl:      14px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -10%, rgba(167,139,250,0.06) 0%, transparent 70%);
    }

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.75rem;
      height: 56px;
      border-bottom: 1px solid var(--border);
      background: rgba(10,10,12,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 50;
      flex-shrink: 0;
    }
    .topbar-brand {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 700;
      font-size: 0.9375rem;
      letter-spacing: 0.04em;
      color: var(--bright);
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }
    .topbar-brand .brand-icon {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8125rem;
      box-shadow: 0 2px 8px rgba(139,104,240,0.35);
    }
    .topbar-brand .dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 6px rgba(74,222,128,0.6);
      animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.75); }
    }
    .topbar-meta {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6875rem;
      color: var(--dim);
      letter-spacing: 0.06em;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .layout { display: flex; flex: 1; min-height: 0; }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 224px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar-section { padding: 1.25rem 0.875rem 0.625rem; }
    .sidebar-label {
      font-size: 0.6875rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--dim);
      padding: 0 0.5rem;
      margin-bottom: 0.375rem;
    }
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.5rem 0.625rem;
      border-radius: var(--r);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.12s, color 0.12s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .sidebar-item:hover { background: var(--surface3); color: var(--text); }
    .sidebar-item.active {
      background: rgba(167,139,250,0.1);
      color: var(--accent3);
    }
    .si-icon { font-size: 0.875rem; flex-shrink: 0; width: 1rem; text-align: center; opacity: 0.8; }
    .si-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .si-count {
      font-size: 0.6875rem;
      font-family: 'IBM Plex Mono', monospace;
      background: var(--surface3);
      color: var(--mid);
      border-radius: 99px;
      padding: 0.1em 0.5em;
      border: 1px solid var(--border);
    }
    .sidebar-item.active .si-count {
      background: rgba(167,139,250,0.12);
      color: var(--accent);
      border-color: rgba(167,139,250,0.2);
    }
    .sidebar-divider { height: 1px; background: var(--border); margin: 0.625rem 0.875rem; }
    .sidebar-add { padding: 0.875rem; margin-top: auto; }
    .btn-new-folder {
      width: 100%;
      padding: 0.5625rem;
      background: none;
      border: 1px dashed var(--border2);
      border-radius: var(--r);
      color: var(--mid);
      font-family: inherit;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    .btn-new-folder:hover {
      border-color: var(--accent);
      color: var(--accent3);
      background: rgba(167,139,250,0.06);
    }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }

    /* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8125rem;
      font-weight: 500;
      flex: 1;
      min-width: 0;
      flex-wrap: wrap;
    }
    .breadcrumb-sep { color: var(--border2); margin: 0 0.1rem; font-size: 0.75rem; }
    .breadcrumb a { color: var(--mid); text-decoration: none; transition: color 0.1s; cursor: pointer; }
    .breadcrumb a:hover { color: var(--accent3); }
    .bc-current { color: var(--bright); font-weight: 600; }

    .toolbar-right { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }

    .search-box { position: relative; }
    .search-box input {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--text);
      font-family: inherit;
      font-size: 0.8125rem;
      padding: 0.4375rem 0.75rem 0.4375rem 2rem;
      width: 210px;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--surface3);
      box-shadow: 0 0 0 3px rgba(167,139,250,0.1);
    }
    .search-box input::placeholder { color: var(--dim); }
    .search-icon {
      position: absolute; left: 0.625rem; top: 50%;
      transform: translateY(-50%);
      color: var(--dim); font-size: 0.8125rem; pointer-events: none;
    }

    .btn-toolbar-folder {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.4375rem 0.875rem;
      background: rgba(167,139,250,0.1);
      border: 1px solid rgba(167,139,250,0.3);
      border-radius: var(--r);
      color: var(--accent3);
      font-family: inherit;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
      white-space: nowrap;
    }
    .btn-toolbar-folder:hover {
      background: rgba(167,139,250,0.18);
      border-color: rgba(167,139,250,0.5);
      box-shadow: 0 0 12px rgba(167,139,250,0.12);
    }

    .sort-select {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--muted);
      font-family: inherit;
      font-size: 0.8125rem;
      font-weight: 500;
      padding: 0.4375rem 0.625rem;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .sort-select:focus { outline: none; border-color: var(--accent); }

    .view-toggle {
      display: flex;
      border: 1px solid var(--border2);
      border-radius: var(--r);
      overflow: hidden;
    }
    .view-btn {
      padding: 0.4375rem 0.625rem;
      background: var(--surface2);
      border: none;
      color: var(--dim);
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.1s, color 0.1s;
    }
    .view-btn.active { background: var(--surface3); color: var(--accent3); }
    .view-btn:hover:not(.active) { background: var(--surface3); color: var(--muted); }

    /* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
    .drop-zone {
      margin: 1.25rem 1.5rem 0;
      border: 1px dashed var(--border2);
      border-radius: var(--rm);
      padding: 1rem 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: var(--surface2);
      flex-shrink: 0;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(167,139,250,0.06);
    }
    .drop-zone p { font-size: 0.8125rem; color: var(--mid); }
    .drop-zone strong { color: var(--muted); font-weight: 600; }

    /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
    .content { flex: 1; overflow-y: auto; padding: 1.25rem 1.5rem 2.5rem; }

    /* ‚îÄ‚îÄ GRID VIEW ‚îÄ‚îÄ */
    .grid-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
      gap: 0.875rem;
    }
    .grid-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--rm);
      padding: 1rem 0.875rem 0.875rem;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, box-shadow 0.15s, transform 0.15s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }
    .grid-card:hover {
      border-color: var(--border3);
      background: var(--surface2);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transform: translateY(-2px);
    }
    .card-thumb {
      width: 64px; height: 64px;
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      flex-shrink: 0;
      border: 1px solid var(--border2);
    }
    .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .card-name {
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      color: var(--text);
      word-break: break-word;
      line-height: 1.4;
      max-width: 100%;
    }
    .card-meta {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.625rem;
      color: var(--dim);
    }
    .card-actions {
      display: none;
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      gap: 0.2rem;
    }
    .grid-card:hover .card-actions { display: flex; }
    .card-action-btn {
      width: 24px; height: 24px;
      background: var(--surface3);
      border: 1px solid var(--border2);
      border-radius: 5px;
      color: var(--mid);
      font-size: 0.6875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.1s, color 0.1s, background 0.1s;
    }
    .card-action-btn:hover { border-color: var(--accent); color: var(--accent3); background: rgba(167,139,250,0.12); }
    .card-action-btn.danger:hover { border-color: var(--red); color: var(--red); background: rgba(248,113,113,0.1); }

    /* ‚îÄ‚îÄ LIST VIEW ‚îÄ‚îÄ */
    .list-view { width: 100%; }
    .list-header {
      display: grid;
      grid-template-columns: 1fr 90px 90px 130px;
      gap: 0.5rem;
      padding: 0.5rem 0.875rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--dim);
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.25rem;
    }
    .list-row {
      display: grid;
      grid-template-columns: 1fr 90px 90px 130px;
      gap: 0.5rem;
      align-items: center;
      padding: 0.5rem 0.875rem;
      border-radius: var(--r);
      cursor: pointer;
      transition: background 0.1s;
      border: 1px solid transparent;
    }
    .list-row:hover { background: var(--surface2); border-color: var(--border); }
    .row-name { display: flex; align-items: center; gap: 0.625rem; overflow: hidden; }
    .row-thumb {
      width: 30px; height: 30px;
      border-radius: 5px;
      overflow: hidden;
      background: var(--surface3);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.875rem; flex-shrink: 0;
      border: 1px solid var(--border2);
    }
    .row-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .row-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .row-size {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      color: var(--dim);
    }
    .row-type { font-size: 0.75rem; color: var(--dim); }
    .row-actions { display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.1s; }
    .list-row:hover .row-actions { opacity: 1; }
    .row-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
      font-family: inherit;
      font-weight: 500;
      background: var(--surface3);
      border: 1px solid var(--border2);
      border-radius: 4px;
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.1s, color 0.1s, background 0.1s;
    }
    .row-btn:hover { border-color: var(--accent); color: var(--accent3); background: rgba(167,139,250,0.1); }
    .row-btn.danger:hover { border-color: var(--red); color: var(--red); background: rgba(248,113,113,0.08); }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 0.875rem;
      padding: 5rem 1rem;
      text-align: center;
      color: var(--dim);
    }
    .empty-state .empty-icon { font-size: 2.75rem; opacity: 0.3; }
    .empty-state p { font-size: 0.875rem; color: var(--mid); line-height: 1.6; max-width: 260px; }

    /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex; align-items: center; justify-content: center;
      z-index: 200; padding: 1rem;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .overlay.hidden { display: none; }
    .modal {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--rl);
      padding: 1.75rem;
      min-width: 340px;
      max-width: 92vw;
      box-shadow: 0 32px 80px rgba(0,0,0,0.7), 0 0 0 1px var(--border);
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--bright);
      margin-bottom: 1.25rem;
      letter-spacing: -0.01em;
    }
    .field-label {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--mid);
      margin-bottom: 0.4rem;
    }
    .field-input {
      width: 100%;
      padding: 0.625rem 0.875rem;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--bright);
      font-family: inherit;
      font-size: 0.9375rem;
      font-weight: 500;
      margin-bottom: 1.25rem;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .field-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(167,139,250,0.12);
    }
    .folder-select {
      width: 100%;
      max-height: 190px;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      margin-bottom: 1.25rem;
    }
    .folder-option {
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--muted);
      transition: background 0.1s, color 0.1s;
    }
    .folder-option:hover { background: var(--surface3); color: var(--text); }
    .folder-option.selected { background: rgba(167,139,250,0.1); color: var(--accent3); }
    .modal-footer {
      display: flex; gap: 0.625rem;
      justify-content: flex-end;
      margin-top: 0.25rem;
    }
    .btn {
      padding: 0.5625rem 1.25rem;
      border-radius: var(--r);
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 12px rgba(167,139,250,0.3);
    }
    .btn-primary:hover {
      background: var(--accent2);
      box-shadow: 0 4px 20px rgba(139,104,240,0.4);
    }
    .btn-ghost {
      background: var(--surface3);
      border: 1px solid var(--border2);
      color: var(--muted);
    }
    .btn-ghost:hover { background: var(--surface); color: var(--text); border-color: var(--border3); }

    /* ‚îÄ‚îÄ TYPE BADGES ‚îÄ‚îÄ */
    .type-badge {
      display: inline-block;
      padding: 0.15em 0.5em;
      border-radius: 4px;
      font-size: 0.625rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .badge-img  { background: rgba(46,125,90,0.18);  color: #4ade80; border: 1px solid rgba(74,222,128,0.2); }
    .badge-doc  { background: rgba(96,130,220,0.18); color: #93c5fd; border: 1px solid rgba(147,197,253,0.2); }
    .badge-vid  { background: rgba(220,80,60,0.18);  color: #fca5a5; border: 1px solid rgba(252,165,165,0.2); }
    .badge-aud  { background: rgba(180,80,220,0.18); color: #d8b4fe; border: 1px solid rgba(216,180,254,0.2); }
    .badge-zip  { background: rgba(167,139,250,0.18);color: var(--accent3); border: 1px solid rgba(167,139,250,0.25); }
    .badge-other{ background: var(--surface3); color: var(--mid); border: 1px solid var(--border); }

    /* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ */
    .preview-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 300; padding: 2rem;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .preview-overlay.hidden { display: none; }
    .preview-close {
      position: absolute; top: 1.25rem; right: 1.25rem;
      width: 38px; height: 38px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--muted);
      font-size: 1.125rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: border-color 0.1s, color 0.1s;
    }
    .preview-close:hover { border-color: var(--accent); color: var(--accent3); }
    .preview-inner {
      max-width: 90vw; max-height: 88vh;
      display: flex; align-items: center; justify-content: center;
    }
    .preview-inner img {
      max-width: 100%; max-height: 88vh;
      object-fit: contain;
      border-radius: var(--rm);
      border: 1px solid var(--border2);
      box-shadow: 0 32px 80px rgba(0,0,0,0.8);
    }
    .preview-placeholder {
      padding: 3rem 4rem;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--rl);
      text-align: center;
      color: var(--mid);
    }
    .big-icon { font-size: 3rem; display: block; margin-bottom: 0.875rem; }

    /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
    .statusbar {
      display: flex; align-items: center; gap: 1.5rem;
      padding: 0.5rem 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--surface);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.6875rem;
      color: var(--dim);
      letter-spacing: 0.04em;
      flex-shrink: 0;
    }
    .statusbar span { display: flex; align-items: center; gap: 0.375rem; }
    .statusbar .s-dot {
      width: 4px; height: 4px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 4px rgba(74,222,128,0.5);
    }

    /* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
    .toast-wrap {
      position: fixed; bottom: 1.5rem; right: 1.5rem;
      z-index: 500; display: flex; flex-direction: column;
      gap: 0.5rem; pointer-events: none;
    }
    .toast {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-left: 3px solid var(--accent);
      border-radius: var(--r);
      padding: 0.75rem 1.125rem;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      animation: toastIn 0.2s ease, toastOut 0.3s ease 2.3s forwards;
    }
    @keyframes toastIn  { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    @keyframes toastOut { to   { opacity:0; transform:translateY(10px); } }

    input[type="file"] { display: none; }

    /* ‚îÄ‚îÄ KEY GATE ‚îÄ‚îÄ */
    .key-gate {
      position: fixed; inset: 0;
      background: var(--bg);
      background-image: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(167,139,250,0.08) 0%, transparent 70%);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; padding: 1rem;
    }
    .key-gate.hidden { display: none; }
    .key-gate-box {
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--rl);
      padding: 2.75rem 2.25rem 2.25rem;
      width: 100%; max-width: 400px;
      box-shadow: 0 40px 100px rgba(0,0,0,0.8), 0 0 0 1px var(--border);
      display: flex; flex-direction: column; align-items: center; gap: 0;
    }
    .key-gate-logo {
      width: 52px; height: 52px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 24px rgba(139,104,240,0.4);
    }
    .key-gate-title {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--bright);
      margin-bottom: 0.375rem;
      letter-spacing: -0.02em;
    }
    .key-gate-sub {
      font-size: 0.875rem;
      color: var(--mid);
      margin-bottom: 2rem;
      text-align: center;
    }
    .key-gate-input-wrap {
      position: relative; width: 100%; margin-bottom: 0.875rem;
    }
    .key-gate-input {
      width: 100%;
      padding: 0.8125rem 3rem 0.8125rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      color: var(--bright);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.9375rem;
      letter-spacing: 0.06em;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .key-gate-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(167,139,250,0.14);
    }
    .key-gate-input.shake {
      animation: shake 0.35s ease;
      border-color: var(--red) !important;
      box-shadow: 0 0 0 3px rgba(248,113,113,0.12) !important;
    }
    @keyframes shake {
      0%,100% { transform:translateX(0); }
      20% { transform:translateX(-8px); }
      40% { transform:translateX(8px); }
      60% { transform:translateX(-5px); }
      80% { transform:translateX(5px); }
    }
    .key-gate-eye {
      position: absolute; right: 0.875rem; top: 50%;
      transform: translateY(-50%);
      background: none; border: none;
      color: var(--dim); cursor: pointer;
      font-size: 1rem; padding: 0.25rem;
      transition: color 0.1s;
    }
    .key-gate-eye:hover { color: var(--muted); }
    .key-gate-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--r);
      font-family: inherit;
      font-size: 0.9375rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
      margin-bottom: 1rem;
      box-shadow: 0 4px 16px rgba(139,104,240,0.35);
    }
    .key-gate-btn:hover {
      background: var(--accent2);
      box-shadow: 0 6px 24px rgba(139,104,240,0.5);
    }
    .key-gate-btn:active { transform: scale(0.98); }
    .key-gate-error {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--red);
      min-height: 1.25em;
      text-align: center;
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--dim); }
  </style>
</head>
<body>

<!-- KEY GATE -->
<div class="key-gate" id="keyGate">
  <div class="key-gate-box">
    <div class="key-gate-logo">üîê</div>
    <div class="key-gate-title">Archive</div>
    <div class="key-gate-sub">Enter your access key to continue</div>
    <div class="key-gate-input-wrap">
      <input class="key-gate-input" type="password" id="keyInput" placeholder="Access key" autocomplete="off" />
      <button class="key-gate-eye" id="keyEye" tabindex="-1" onclick="App.toggleKeyVis()">üëÅ</button>
    </div>
    <button class="key-gate-btn" onclick="App.submitKey()">Unlock</button>
    <div class="key-gate-error" id="keyError"></div>
  </div>
</div>

<div class="topbar">
  <div class="topbar-brand">
    <div class="brand-icon">üì¶</div>
    Archive
    <span class="dot"></span>
  </div>
  <div class="topbar-meta" id="topbarMeta">READY</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Views</div>
      <button class="sidebar-item active" id="navAll" onclick="App.navAll()">
        <span class="si-icon">‚óà</span><span class="si-name">All files</span><span class="si-count" id="countAll">0</span>
      </button>
      <button class="sidebar-item" id="navImages" onclick="App.navType('image')">
        <span class="si-icon">‚ñ£</span><span class="si-name">Images</span><span class="si-count" id="countImages">0</span>
      </button>
      <button class="sidebar-item" id="navDocs" onclick="App.navType('doc')">
        <span class="si-icon">‚ñ§</span><span class="si-name">Documents</span><span class="si-count" id="countDocs">0</span>
      </button>
      <button class="sidebar-item" id="navOther" onclick="App.navType('other')">
        <span class="si-icon">‚ñ¶</span><span class="si-name">Other</span><span class="si-count" id="countOther">0</span>
      </button>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" style="flex:1">
      <div class="sidebar-label">Folders</div>
      <div id="folderList"></div>
    </div>
    <div class="sidebar-add">
      <button class="btn-new-folder" onclick="App.openNewFolder()">Ôºã New Folder</button>
    </div>
  </aside>

  <div class="main">
    <div class="toolbar">
      <div class="breadcrumb" id="breadcrumb"></div>
      <div class="toolbar-right">
        <button class="btn-toolbar-folder" onclick="App.openNewFolder()">üìÅ New Folder</button>
        <div class="search-box">
          <span class="search-icon">‚åï</span>
          <input type="search" placeholder="Search‚Ä¶" id="searchInput" oninput="App.onSearch(this.value)" />
        </div>
        <select class="sort-select" id="sortSelect" onchange="App.onSort(this.value)">
          <option value="name">Name A‚ÄìZ</option>
          <option value="nameDesc">Name Z‚ÄìA</option>
          <option value="date">Date (newest)</option>
          <option value="size">Size (largest)</option>
          <option value="type">Type</option>
        </select>
        <div class="view-toggle">
          <button class="view-btn active" id="viewGrid" onclick="App.setView('grid')" title="Grid">‚äû</button>
          <button class="view-btn" id="viewList" onclick="App.setView('list')" title="List">‚ò∞</button>
        </div>
      </div>
    </div>

    <div class="drop-zone" id="dropZone">
      <p>Drop files here ¬∑ or <strong>click to upload</strong></p>
    </div>

    <div class="content" id="content"></div>

    <div class="statusbar">
      <span><span class="s-dot"></span>ARCHIVE</span>
      <span id="sbCount">0 items</span>
      <span id="sbSize">0 B</span>
      <span id="syncStatus" style="margin-left:auto;font-size:0.6875rem;color:var(--mid);">‚ü≥ Connecting‚Ä¶</span>
    </div>
  </div>
</div>

<!-- NEW FOLDER MODAL -->
<div class="overlay hidden" id="overlayNewFolder">
  <div class="modal">
    <div class="modal-title">New Folder</div>
    <div class="field-label">Name</div>
    <input class="field-input" id="newFolderName" placeholder="Untitled Folder" />
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('overlayNewFolder')">Cancel</button>
      <button class="btn btn-primary" onclick="App.confirmNewFolder()">Create</button>
    </div>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="overlay hidden" id="overlayRename">
  <div class="modal">
    <div class="modal-title" id="renameMTitle">Rename</div>
    <div class="field-label">New name</div>
    <input class="field-input" id="renameInput" placeholder="Name" />
    <input type="hidden" id="renameId" />
    <input type="hidden" id="renameKind" />
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('overlayRename')">Cancel</button>
      <button class="btn btn-primary" onclick="App.confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- MOVE MODAL -->
<div class="overlay hidden" id="overlayMove">
  <div class="modal">
    <div class="modal-title">Move To</div>
    <div class="field-label">Choose destination</div>
    <div class="folder-select" id="moveFolderList"></div>
    <input type="hidden" id="moveId" />
    <input type="hidden" id="moveKind" />
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="App.closeModal('overlayMove')">Cancel</button>
      <button class="btn btn-primary" onclick="App.confirmMove()">Move</button>
    </div>
  </div>
</div>

<!-- PREVIEW -->
<div class="preview-overlay hidden" id="previewOverlay">
  <button class="preview-close" onclick="App.closePreview()">‚úï</button>
  <div class="preview-inner" id="previewInner"></div>
</div>

<div class="toast-wrap" id="toastWrap"></div>
<input type="file" id="fileInput" multiple onchange="App.onFileInputChange(this)" />

<script>
const App = (function () {

  function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

  let state = { folders: [], files: [] };
  let viewMode = 'grid';
  let currentFolderId = null;
  let filterType = null;
  let searchQuery = '';
  let sortBy = 'name';
  let moveSelected = undefined; // undefined = not picked, null = root

  // ‚îÄ‚îÄ SHARED STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Uses window.storage with shared:true so ALL users see the same files.
  // Metadata (folders + file list) stored as JSON under one key.
  // File binary data stored as base64 strings, chunked at 3MB each
  // to stay under the 5MB-per-key limit.
  const META_KEY   = 'archive:meta:v1';
  const CHUNK_SIZE = 3 * 1024 * 1024; // 3MB per chunk (base64 ~4MB stored)

  // Convert ArrayBuffer ‚Üí base64 string
  function bufToB64(buf) {
    let bin = '';
    const bytes = new Uint8Array(buf);
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }

  // Convert base64 string ‚Üí ArrayBuffer
  function b64ToBuf(b64) {
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return bytes.buffer;
  }

  // Save metadata (folders + file list) to shared storage
  async function save() {
    const meta = {
      folders: state.folders,
      files: state.files.map(f => ({
        id: f.id, name: f.name, size: f.size,
        type: f.type, ext: f.ext, mime: f.mime || '',
        folderId: f.folderId, dateAdded: f.dateAdded, dataKey: f.dataKey
      }))
    };
    try {
      await window.storage.set(META_KEY, JSON.stringify(meta), true);
    } catch(e) {
      console.error('Failed to save metadata:', e);
    }
  }

  // Load metadata from shared storage
  async function load() {
    try {
      const result = await window.storage.get(META_KEY, true);
      if (result && result.value) {
        const p = JSON.parse(result.value);
        state.folders = p.folders || [];
        state.files   = p.files   || [];
      }
    } catch(e) {
      console.error('Failed to load metadata:', e);
    }
  }

  // Save file binary data to shared storage (chunked for large files)
  async function saveFileData(dataKey, arrayBuffer) {
    const b64 = bufToB64(arrayBuffer);
    const totalChunks = Math.ceil(b64.length / CHUNK_SIZE);
    // Store chunk count first
    await window.storage.set(`archive:file:${dataKey}:info`,
      JSON.stringify({ chunks: totalChunks, size: arrayBuffer.byteLength }), true);
    // Store each chunk
    for (let i = 0; i < totalChunks; i++) {
      const chunk = b64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
      await window.storage.set(`archive:file:${dataKey}:${i}`, chunk, true);
    }
  }

  // Read file binary data from shared storage (reassemble chunks)
  async function getFileData(dataKey) {
    try {
      const infoRes = await window.storage.get(`archive:file:${dataKey}:info`, true);
      if (!infoRes || !infoRes.value) return null;
      const { chunks } = JSON.parse(infoRes.value);
      let b64 = '';
      for (let i = 0; i < chunks; i++) {
        const chunkRes = await window.storage.get(`archive:file:${dataKey}:${i}`, true);
        if (!chunkRes || !chunkRes.value) return null;
        b64 += chunkRes.value;
      }
      return b64ToBuf(b64);
    } catch(e) {
      return null;
    }
  }

  // Delete file data chunks from shared storage
  async function deleteFileData(dataKey) {
    try {
      const infoRes = await window.storage.get(`archive:file:${dataKey}:info`, true);
      if (infoRes && infoRes.value) {
        const { chunks } = JSON.parse(infoRes.value);
        for (let i = 0; i < chunks; i++) {
          await window.storage.delete(`archive:file:${dataKey}:${i}`, true);
        }
      }
      await window.storage.delete(`archive:file:${dataKey}:info`, true);
    } catch(e) {}
  }

  // ‚îÄ‚îÄ LIVE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Poll shared storage every 5 seconds and re-render if metadata changed.
  let lastMetaHash = '';
  let syncInterval = null;

  function startSync() {
    syncInterval = setInterval(async () => {
      try {
        const result = await window.storage.get(META_KEY, true);
        const val = (result && result.value) || '';
        if (val !== lastMetaHash) {
          lastMetaHash = val;
          if (val) {
            const p = JSON.parse(val);
            const incoming = { folders: p.folders || [], files: p.files || [] };
            // Merge: add any files/folders we don't already have locally
            let changed = false;
            incoming.files.forEach(f => {
              if (!state.files.find(x => x.id === f.id)) {
                state.files.push(f);
                changed = true;
              }
            });
            incoming.folders.forEach(f => {
              if (!state.folders.find(x => x.id === f.id)) {
                state.folders.push(f);
                changed = true;
              }
            });
            // Also catch remote deletions
            const remoteFileIds = new Set(incoming.files.map(f => f.id));
            const remoteFldrIds = new Set(incoming.folders.map(f => f.id));
            const before = state.files.length + state.folders.length;
            state.files   = state.files.filter(f => remoteFileIds.has(f.id));
            state.folders = state.folders.filter(f => remoteFldrIds.has(f.id));
            if (state.files.length + state.folders.length !== before) changed = true;
            if (changed) { render(); updateCounts(); setSyncStatus('synced'); }
          }
        }
      } catch(e) {}
    }, 5000);
  }

  function setSyncStatus(status) {
    const el = document.getElementById('syncStatus');
    if (!el) return;
    if (status === 'syncing') {
      el.textContent = '‚ü≥ Syncing‚Ä¶';
      el.style.color = 'var(--mid)';
    } else if (status === 'synced') {
      el.textContent = '‚úì Live';
      el.style.color = 'var(--green)';
    } else if (status === 'error') {
      el.textContent = '‚úï Offline';
      el.style.color = 'var(--red)';
    }
  }

  // ‚îÄ‚îÄ FILE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const IMG = /^(jpg|jpeg|png|gif|webp|bmp|svg|avif)$/i;
  const DOC = /^(pdf|doc|docx|txt|md|xls|xlsx|ppt|pptx|csv|rtf|odt)$/i;
  const VID = /^(mp4|mov|avi|mkv|webm|flv)$/i;
  const AUD = /^(mp3|wav|ogg|flac|aac|m4a)$/i;
  const ZIP = /^(zip|rar|7z|tar|gz|bz2)$/i;

  function getExt(name) { const i = name.lastIndexOf('.'); return i > 0 ? name.slice(i+1).toLowerCase() : ''; }

  function classifyType(ext) {
    if (IMG.test(ext)) return 'image';
    if (DOC.test(ext)) return 'doc';
    if (VID.test(ext)) return 'video';
    if (AUD.test(ext)) return 'audio';
    if (ZIP.test(ext)) return 'zip';
    return 'other';
  }

  // Explicit MIME map for common binary/game/dev formats so browsers
  // download them correctly rather than trying to open them inline.
  const MIME_MAP = {
    exe: 'application/octet-stream',
    msi: 'application/octet-stream',
    dll: 'application/octet-stream',
    unitypackage: 'application/octet-stream',
    apk: 'application/vnd.android.package-archive',
    ipa: 'application/octet-stream',
    dmg: 'application/octet-stream',
    iso: 'application/octet-stream',
    bin: 'application/octet-stream',
    dat: 'application/octet-stream',
    pkg: 'application/octet-stream',
    deb: 'application/octet-stream',
    rpm: 'application/octet-stream',
    jar: 'application/java-archive',
    war: 'application/java-archive',
    psd: 'image/vnd.adobe.photoshop',
    ai:  'application/postscript',
    blend: 'application/octet-stream',
    fbx: 'application/octet-stream',
    obj: 'text/plain',
    unity: 'application/octet-stream',
    prefab: 'application/octet-stream',
    asset: 'application/octet-stream',
    mat: 'application/octet-stream',
  };

  function typeBadge(type, extLabel) {
    const cls = {image:'badge-img',doc:'badge-doc',video:'badge-vid',audio:'badge-aud',zip:'badge-zip',other:'badge-other'}[type]||'badge-other';
    return `<span class="type-badge ${cls}">${extLabel||type}</span>`;
  }

  function typeIcon(type) {
    return {image:'üñº',doc:'üìÑ',video:'üé¨',audio:'üéµ',zip:'üì¶',other:'üìé'}[type]||'üìé';
  }

  function formatSize(b) {
    if (!b) return '‚Äî';
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
    return (b/1048576).toFixed(1) + ' MB';
  }

  function escH(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s; return d.innerHTML;
  }

  function setText(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }

  // ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function processFiles(fileList) {
    const arr = Array.from(fileList);
    if (!arr.length) return;
    let done = 0;
    setSyncStatus('syncing');
    toast(`Uploading ${arr.length} file${arr.length > 1 ? 's' : ''}‚Ä¶`);

    arr.forEach(file => {
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const ext  = getExt(file.name);
          const type = classifyType(ext);
          const dataKey = genId();
          const entry = {
            id: genId(), name: file.name, size: file.size,
            type, ext,
            mime: file.type || 'application/octet-stream',
            folderId: filterType ? null : currentFolderId,
            dateAdded: Date.now(), dataKey
          };

          await saveFileData(dataKey, e.target.result);

          // Pre-populate thumb cache for images
          if (type === 'image') {
            const mime = file.type || getMimeByExt(ext) || 'image/jpeg';
            const blob = new Blob([e.target.result], { type: mime });
            thumbCache[dataKey] = URL.createObjectURL(blob);
          }

          state.files.push(entry);
          if (++done === arr.length) {
            await save();
            // Update the hash so sync loop doesn't double-render
            const r = await window.storage.get(META_KEY, true).catch(() => null);
            if (r) lastMetaHash = r.value || '';
            render(); updateCounts();
            setSyncStatus('synced');
            toast(`Added ${arr.length} file${arr.length > 1 ? 's' : ''}`);
          }
        } catch(err) {
          console.error('Upload error:', err);
          toast(`Failed to store "${file.name}"`);
          if (++done === arr.length) { await save(); render(); updateCounts(); setSyncStatus('error'); }
        }
      };
      reader.onerror = () => {
        toast(`Failed to read "${file.name}"`);
        if (++done === arr.length) { save(); render(); updateCounts(); }
      };
      reader.readAsArrayBuffer(file);
    });
  }

  function onFileInputChange(inp) { processFiles(inp.files); inp.value = ''; }

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function navAll() {
    filterType = null; currentFolderId = null; searchQuery = '';
    document.getElementById('searchInput').value = '';
    setActiveNav('navAll'); render();
  }

  function navType(type) {
    filterType = type; currentFolderId = null; searchQuery = '';
    document.getElementById('searchInput').value = '';
    const map = {image:'navImages',doc:'navDocs',other:'navOther'};
    setActiveNav(map[type]); render();
  }

  function navFolder(folderId) {
    filterType = null; currentFolderId = folderId; searchQuery = '';
    document.getElementById('searchInput').value = '';
    setActiveNav('folder_' + folderId); render();
  }

  function setActiveNav(id) {
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  }

  function onSearch(q) { searchQuery = q.trim().toLowerCase(); render(); }
  function onSort(v) { sortBy = v; render(); }
  function setView(v) {
    viewMode = v;
    document.getElementById('viewGrid').classList.toggle('active', v==='grid');
    document.getElementById('viewList').classList.toggle('active', v==='list');
    render();
  }

  // ‚îÄ‚îÄ GET VISIBLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getVisible() {
    let folders = [...state.folders];
    let files = [...state.files];

    if (filterType) {
      const allowed = filterType === 'image' ? ['image'] : filterType === 'doc' ? ['doc'] : ['other','zip','audio','video'];
      files = files.filter(f => allowed.includes(f.type));
      folders = [];
    } else {
      folders = folders.filter(f => f.parentId === currentFolderId);
      files = files.filter(f => f.folderId === currentFolderId);
    }

    if (searchQuery) {
      folders = folders.filter(f => f.name.toLowerCase().includes(searchQuery));
      files = files.filter(f => f.name.toLowerCase().includes(searchQuery));
    }

    const sort = arr => arr.sort((a, b) => {
      if (sortBy === 'name') return a.name.localeCompare(b.name);
      if (sortBy === 'nameDesc') return b.name.localeCompare(a.name);
      if (sortBy === 'date') return (b.dateAdded||0) - (a.dateAdded||0);
      if (sortBy === 'size') return (b.size||0) - (a.size||0);
      if (sortBy === 'type') return (a.type||'').localeCompare(b.type||'');
      return 0;
    });

    return { folders: sort(folders), files: sort(files) };
  }

  // ‚îÄ‚îÄ THUMBNAIL BLOB URL CACHE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Blob URLs are created once per session and reused on every render.
  // This prevents the broken-image issue caused by URLs being revoked
  // or never resolving before innerHTML is written.
  const thumbCache = {}; // dataKey ‚Üí blob URL string

  function ensureThumbsForFiles(files) {
    // Kick off IDB reads for any image files not yet cached, then re-render thumbnails
    const imgFiles = files.filter(f => f.type === 'image' && !thumbCache[f.dataKey]);
    if (!imgFiles.length) return;
    imgFiles.forEach(f => {
      getFileData(f.dataKey).then(buffer => {
        if (!buffer) return;
        const mime = f.mime || getMimeByExt(f.ext) || 'image/jpeg';
        const blob = new Blob([buffer], { type: mime });
        thumbCache[f.dataKey] = URL.createObjectURL(blob);
        // Patch any currently-visible placeholder for this file in-place
        document.querySelectorAll(`.thumb-placeholder[data-key="${f.dataKey}"]`).forEach(el => {
          const img = document.createElement('img');
          img.src = thumbCache[f.dataKey];
          img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit;';
          el.replaceWith(img);
        });
      }).catch(() => {});
    });
  }

  function thumbHtml(f, large) {
    // If we already have a cached blob URL, render a real <img> immediately
    if (thumbCache[f.dataKey]) {
      const s = large
        ? 'width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit;'
        : 'width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit;';
      return `<img src="${thumbCache[f.dataKey]}" style="${s}" alt="" />`;
    }
    // Otherwise render a placeholder span; ensureThumbsForFiles will swap it in
    const style = large
      ? 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1.75rem;'
      : 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:0.875rem;';
    return `<span class="thumb-placeholder" data-key="${f.dataKey}" style="${style}">üñº</span>`;
  }

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function render() {
    renderBreadcrumb();
    renderFolderSidebar();
    const { folders, files } = getVisible();
    const content = document.getElementById('content');

    if (!folders.length && !files.length) {
      content.innerHTML = `<div class="empty-state">
        <span class="empty-icon">‚óà</span>
        <p>${searchQuery ? 'No results for "'+escH(searchQuery)+'"' : 'Drop files here or click the upload area above'}</p>
      </div>`;
    } else if (viewMode === 'grid') {
      content.innerHTML = '<div class="grid-view">' +
        folders.map(renderFolderCard).join('') +
        files.map(renderFileCard).join('') +
      '</div>';
    } else {
      content.innerHTML = `<div class="list-view">
        <div class="list-header"><div>Name</div><div>Size</div><div>Type</div><div>Actions</div></div>` +
        folders.map(renderFolderRow).join('') +
        files.map(renderFileRow).join('') +
      '</div>';
    }

    attachEvents();
    // Kick off background thumb loading for any images not yet cached
    ensureThumbsForFiles(files);

    const total = files.reduce((s, f) => s + (f.size||0), 0);
    setText('sbCount', `${folders.length + files.length} items`);
    setText('sbSize', formatSize(total));
    const allTotal = state.files.reduce((s, f) => s + (f.size||0), 0);
    setText('topbarMeta', `${state.files.length} FILES ¬∑ ${formatSize(allTotal)}`);
  }

  function renderFolderCard(f) {
    const count = state.files.filter(x => x.folderId === f.id).length + state.folders.filter(x => x.parentId === f.id).length;
    return `<div class="grid-card" data-type="folder" data-id="${f.id}">
      <div class="card-actions">
        <button class="card-action-btn" data-action="rename" data-id="${f.id}" data-kind="folder" title="Rename">‚úé</button>
        <button class="card-action-btn" data-action="move" data-id="${f.id}" data-kind="folder" title="Move">‚á•</button>
        <button class="card-action-btn danger" data-action="delete" data-id="${f.id}" data-kind="folder" title="Delete">‚úï</button>
      </div>
      <div class="card-thumb">üìÅ</div>
      <div class="card-name">${escH(f.name)}</div>
      <div class="card-meta">${count} item${count!==1?'s':''}</div>
    </div>`;
  }

  function renderFileCard(f) {
    const inner = f.type === 'image' ? thumbHtml(f, true) : typeIcon(f.type);
    return `<div class="grid-card" data-type="file" data-id="${f.id}">
      <div class="card-actions">
        <button class="card-action-btn" data-action="preview" data-id="${f.id}" title="Preview">‚äô</button>
        <button class="card-action-btn" data-action="download" data-id="${f.id}" title="Download">‚Üì</button>
        <button class="card-action-btn" data-action="rename" data-id="${f.id}" data-kind="file" title="Rename">‚úé</button>
        <button class="card-action-btn" data-action="move" data-id="${f.id}" data-kind="file" title="Move">‚á•</button>
        <button class="card-action-btn danger" data-action="delete" data-id="${f.id}" data-kind="file" title="Delete">‚úï</button>
      </div>
      <div class="card-thumb">${inner}</div>
      <div class="card-name">${escH(f.name)}</div>
      <div class="card-meta">${formatSize(f.size)}</div>
    </div>`;
  }

  function renderFolderRow(f) {
    return `<div class="list-row" data-type="folder" data-id="${f.id}">
      <div class="row-name"><div class="row-thumb">üìÅ</div><span class="row-label">${escH(f.name)}</span></div>
      <div class="row-size">‚Äî</div>
      <div class="row-type">Folder</div>
      <div class="row-actions">
        <button class="row-btn" data-action="rename" data-id="${f.id}" data-kind="folder">Rename</button>
        <button class="row-btn" data-action="move" data-id="${f.id}" data-kind="folder">Move</button>
        <button class="row-btn danger" data-action="delete" data-id="${f.id}" data-kind="folder">Delete</button>
      </div>
    </div>`;
  }

  function renderFileRow(f) {
    const inner = f.type === 'image' ? thumbHtml(f, false) : typeIcon(f.type);
    return `<div class="list-row" data-type="file" data-id="${f.id}">
      <div class="row-name"><div class="row-thumb">${inner}</div><span class="row-label">${escH(f.name)}</span></div>
      <div class="row-size">${formatSize(f.size)}</div>
      <div class="row-type">${typeBadge(f.type, f.ext.toUpperCase())}</div>
      <div class="row-actions">
        <button class="row-btn" data-action="preview" data-id="${f.id}">View</button>
        <button class="row-btn" data-action="download" data-id="${f.id}">‚Üì</button>
        <button class="row-btn" data-action="rename" data-id="${f.id}" data-kind="file">Rename</button>
        <button class="row-btn" data-action="move" data-id="${f.id}" data-kind="file">Move</button>
        <button class="row-btn danger" data-action="delete" data-id="${f.id}" data-kind="file">Delete</button>
      </div>
    </div>`;
  }

  function attachEvents() {
    document.querySelectorAll('.grid-card[data-type="folder"], .list-row[data-type="folder"]').forEach(card => {
      card.addEventListener('dblclick', () => navFolder(card.dataset.id));
    });
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const { action, id, kind } = btn.dataset;
        if (action === 'preview') openPreview(id);
        else if (action === 'download') downloadFile(id);
        else if (action === 'rename') openRename(id, kind);
        else if (action === 'move') openMove(id, kind);
        else if (action === 'delete') deleteItem(id, kind);
      });
    });
  }

  // ‚îÄ‚îÄ BREADCRUMB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderBreadcrumb() {
    const el = document.getElementById('breadcrumb');
    if (filterType) {
      el.innerHTML = `<span class="bc-current">{{LABEL}}</span>`.replace('{{LABEL}}', {image:'Images',doc:'Documents',other:'Other'}[filterType]);
      return;
    }
    const path = [];
    let id = currentFolderId;
    while (id) {
      const f = state.folders.find(x => x.id === id);
      if (!f) break;
      path.unshift(f);
      id = f.parentId;
    }
    if (!currentFolderId) {
      el.innerHTML = `<span class="bc-current">All files</span>`;
    } else {
      let html = `<a onclick="App.navAll()">All files</a>`;
      path.forEach((f, i) => {
        html += `<span class="breadcrumb-sep">/</span>`;
        if (i < path.length - 1) html += `<a onclick="App.navFolder('${f.id}')">${escH(f.name)}</a>`;
        else html += `<span class="bc-current">${escH(f.name)}</span>`;
      });
      el.innerHTML = html;
    }
  }

  // ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderFolderSidebar() {
    const el = document.getElementById('folderList');
    const roots = state.folders.filter(f => !f.parentId);

    function renderLevel(folders, depth) {
      return folders.map(f => {
        const children = state.folders.filter(x => x.parentId === f.id);
        const count = state.files.filter(x => x.folderId === f.id).length;
        return `<button class="sidebar-item" id="folder_${f.id}" onclick="App.navFolder('${f.id}')"
          style="padding-left:calc(0.5rem + ${depth*0.75}rem)">
          <span class="si-icon">üìÅ</span>
          <span class="si-name">${escH(f.name)}</span>
          <span class="si-count">${count}</span>
        </button>` + (children.length ? renderLevel(children, depth+1) : '');
      }).join('');
    }

    el.innerHTML = roots.length
      ? renderLevel(roots, 0)
      : `<div style="padding:0.5rem 0.5rem;font-size:0.75rem;color:var(--dim)">No folders yet</div>`;

    updateCounts();
  }

  function updateCounts() {
    setText('countAll', state.files.length);
    setText('countImages', state.files.filter(f=>f.type==='image').length);
    setText('countDocs', state.files.filter(f=>f.type==='doc').length);
    setText('countOther', state.files.filter(f=>!['image','doc'].includes(f.type)).length);
  }

  // ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openPreview(fileId) {
    const f = state.files.find(x => x.id === fileId);
    if (!f) return;
    const inner = document.getElementById('previewInner');
    inner.innerHTML = '<div class="preview-placeholder"><span class="big-icon">‚è≥</span><div style="color:var(--bright)">Loading‚Ä¶</div></div>';
    document.getElementById('previewOverlay').classList.remove('hidden');

    getFileData(f.dataKey).then(buffer => {
      inner.innerHTML = '';
      if (!buffer) {
        inner.innerHTML = `<div class="preview-placeholder">
          <span class="big-icon">‚ö†</span>
          <div style="color:var(--bright)">File data not found</div>
          <div style="margin-top:0.5rem;font-size:0.75rem">Try re-uploading the file</div>
        </div>`; return;
      }
      if (f.type === 'image') {
        const mime = getMime(f);
        const blob = new Blob([buffer], { type: mime });
        const url  = URL.createObjectURL(blob);
        const img  = document.createElement('img');
        img.src = url; img.alt = f.name;
        img.onload = () => {}; // keep url alive while visible
        inner.appendChild(img);
        // Revoke when preview closes
        inner.dataset.blobUrl = url;
      } else {
        inner.innerHTML = `<div class="preview-placeholder">
          <span class="big-icon">${typeIcon(f.type)}</span>
          <div style="color:var(--bright)">${escH(f.name)}</div>
          <div style="margin-top:0.5rem;font-size:0.75rem">${formatSize(f.size)} ¬∑ ${f.ext.toUpperCase()}</div>
          <div style="margin-top:1.25rem">
            <button class="btn btn-primary" onclick="App.downloadFile('${f.id}')">Download file</button>
          </div>
        </div>`;
      }
    }).catch(() => {
      inner.innerHTML = `<div class="preview-placeholder">
        <span class="big-icon">‚ö†</span>
        <div style="color:var(--bright)">Could not load file</div>
      </div>`;
    });
  }

  function closePreview() {
    // Clean up any blob URL created for image preview
    const inner = document.getElementById('previewInner');
    if (inner.dataset.blobUrl) {
      URL.revokeObjectURL(inner.dataset.blobUrl);
      delete inner.dataset.blobUrl;
    }
    document.getElementById('previewOverlay').classList.add('hidden');
  }

  // ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getMimeByExt(ext) {
    const imgMime = { jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', gif:'image/gif', webp:'image/webp', bmp:'image/bmp', svg:'image/svg+xml', avif:'image/avif' };
    return imgMime[(ext||'').toLowerCase()] || (MIME_MAP[(ext||'').toLowerCase()]) || 'application/octet-stream';
  }

  function getMime(f) {
    return getMimeByExt(f.ext) || f.mime || 'application/octet-stream';
  }

  function downloadFile(fileId) {
    const f = state.files.find(x => x.id === fileId);
    if (!f) return;
    getFileData(f.dataKey).then(buffer => {
      if (!buffer) { toast('File data not found ‚Äî try re-uploading the file'); return; }
      const mime = getMime(f);
      const blob = new Blob([buffer], { type: mime });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = f.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 30000);
    }).catch(() => toast('Download failed ‚Äî file data could not be read'));
  }

  // ‚îÄ‚îÄ NEW FOLDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openNewFolder() {
    document.getElementById('newFolderName').value = '';
    document.getElementById('overlayNewFolder').classList.remove('hidden');
    setTimeout(() => document.getElementById('newFolderName').focus(), 50);
  }

  function confirmNewFolder() {
    const name = document.getElementById('newFolderName').value.trim();
    if (!name) return;
    state.folders.push({ id: genId(), name, parentId: filterType ? null : currentFolderId, dateAdded: Date.now() });
    save(); closeModal('overlayNewFolder'); render();
    toast(`Folder "${name}" created`);
  }

  // ‚îÄ‚îÄ RENAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openRename(id, kind) {
    const item = kind === 'folder' ? state.folders.find(x=>x.id===id) : state.files.find(x=>x.id===id);
    if (!item) return;
    document.getElementById('renameInput').value = item.name;
    document.getElementById('renameId').value = id;
    document.getElementById('renameKind').value = kind;
    document.getElementById('renameMTitle').textContent = 'Rename ' + kind;
    document.getElementById('overlayRename').classList.remove('hidden');
    setTimeout(() => document.getElementById('renameInput').focus(), 50);
  }

  function confirmRename() {
    const id = document.getElementById('renameId').value;
    const kind = document.getElementById('renameKind').value;
    const name = document.getElementById('renameInput').value.trim();
    if (!name) return;
    const arr = kind === 'folder' ? state.folders : state.files;
    const item = arr.find(x => x.id === id);
    if (item) item.name = name;
    save(); closeModal('overlayRename'); render();
  }

  // ‚îÄ‚îÄ MOVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openMove(id, kind) {
    document.getElementById('moveId').value = id;
    document.getElementById('moveKind').value = kind;
    moveSelected = undefined;

    let excluded = new Set();
    if (kind === 'folder') {
      excluded.add(id);
      const collectDesc = fid => state.folders.filter(x=>x.parentId===fid).forEach(x=>{ excluded.add(x.id); collectDesc(x.id); });
      collectDesc(id);
    }

    const opts = [{ id: null, label: '/ Root', depth: 0 }];
    const buildTree = (parentId, depth) => {
      state.folders.filter(f => f.parentId === parentId && !excluded.has(f.id))
        .forEach(f => { opts.push({ id: f.id, label: f.name, depth }); buildTree(f.id, depth+1); });
    };
    buildTree(null, 1);

    const list = document.getElementById('moveFolderList');
    list.innerHTML = opts.map(o =>
      `<div class="folder-option" style="padding-left:calc(0.75rem + ${o.depth*0.75}rem)"
        data-fid="${o.id||'__root__'}"
        onclick="App.selectMoveTarget(this, ${o.id===null?'null':"'"+o.id+"'"})">
        ${o.id===null?'üìÇ':'üìÅ'} ${escH(o.label)}
      </div>`
    ).join('');

    document.getElementById('overlayMove').classList.remove('hidden');
  }

  function selectMoveTarget(el, folderId) {
    document.querySelectorAll('#moveFolderList .folder-option').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    moveSelected = folderId;
  }

  function confirmMove() {
    if (moveSelected === undefined) { toast('Please select a destination'); return; }
    const id = document.getElementById('moveId').value;
    const kind = document.getElementById('moveKind').value;
    const arr = kind === 'folder' ? state.folders : state.files;
    const item = arr.find(x => x.id === id);
    if (item) {
      if (kind === 'folder') item.parentId = moveSelected;
      else item.folderId = moveSelected;
    }
    save(); closeModal('overlayMove'); render();
    toast('Moved successfully');
  }

  // ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function deleteItem(id, kind) {
    const arr = kind === 'folder' ? state.folders : state.files;
    const item = arr.find(x => x.id === id);
    const name = item ? item.name : 'this item';
    if (!confirm(`Delete "${name}"?${kind==='folder'?'\n\nAll folder contents will also be deleted.':''}`)) return;
    if (kind === 'folder') deleteFolder(id);
    else deleteFile(id);
    save(); render();
    toast('Deleted');
  }

  function deleteFolder(folderId) {
    state.folders.filter(f => f.parentId === folderId).forEach(f => deleteFolder(f.id));
    state.files.filter(f => f.folderId === folderId).forEach(f => deleteFile(f.id));
    state.folders = state.folders.filter(f => f.id !== folderId);
  }

  function deleteFile(fileId) {
    const f = state.files.find(x => x.id === fileId);
    if (f) {
      deleteFileData(f.dataKey).catch(() => {});
      if (thumbCache[f.dataKey]) {
        URL.revokeObjectURL(thumbCache[f.dataKey]);
        delete thumbCache[f.dataKey];
      }
    }
    state.files = state.files.filter(x => x.id !== fileId);
  }

  // ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toast(msg) {
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }

  // ‚îÄ‚îÄ KEY GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CORRECT_KEY = 'monkeylikesfemboys';
  const KEY_SESSION = 'archive_unlocked';

  function isUnlocked() {
    return sessionStorage.getItem(KEY_SESSION) === '1';
  }

  function showKeyGate() {
    document.getElementById('keyGate').classList.remove('hidden');
    setTimeout(() => document.getElementById('keyInput').focus(), 80);
    // Enter key submits
    document.getElementById('keyInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitKey();
    });
  }

  function hideKeyGate() {
    document.getElementById('keyGate').classList.add('hidden');
  }

  function submitKey() {
    const val = document.getElementById('keyInput').value;
    const errEl = document.getElementById('keyError');
    if (val === CORRECT_KEY) {
      sessionStorage.setItem(KEY_SESSION, '1');
      hideKeyGate();
      setSyncStatus('syncing');
      load().then(() => {
        render();
        setSyncStatus('synced');
        startSync();
      });
    } else {
      errEl.textContent = 'Incorrect key ‚Äî try again';
      const inp = document.getElementById('keyInput');
      inp.classList.remove('shake');
      void inp.offsetWidth;
      inp.classList.add('shake');
      inp.value = '';
      setTimeout(() => { inp.classList.remove('shake'); errEl.textContent = ''; }, 1500);
    }
  }

  function toggleKeyVis() {
    const inp = document.getElementById('keyInput');
    inp.type = inp.type === 'password' ? 'text' : 'password';
  }

  // ‚îÄ‚îÄ DROP & KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function init() {
    if (isUnlocked()) {
      hideKeyGate();
      setSyncStatus('syncing');
      load().then(() => {
        render();
        setSyncStatus('synced');
        startSync();
      });
    } else {
      showKeyGate();
    }

    const zone = document.getElementById('dropZone');
    zone.addEventListener('click', () => document.getElementById('fileInput').click());
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag-over'); if (e.dataTransfer.files.length) processFiles(e.dataTransfer.files); });

    document.body.addEventListener('dragover', e => e.preventDefault());
    document.body.addEventListener('drop', e => { e.preventDefault(); if (e.target !== zone && e.dataTransfer.files.length) processFiles(e.dataTransfer.files); });

    document.getElementById('previewOverlay').addEventListener('click', e => { if (e.target === document.getElementById('previewOverlay')) closePreview(); });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') { closePreview(); closeModal('overlayNewFolder'); closeModal('overlayRename'); closeModal('overlayMove'); }
      if (e.key === 'Enter' && !document.getElementById('overlayNewFolder').classList.contains('hidden')) confirmNewFolder();
      if (e.key === 'Enter' && !document.getElementById('overlayRename').classList.contains('hidden')) confirmRename();
    });
  }

  init();

  return { navAll, navType, navFolder, onSearch, onSort, setView,
    openNewFolder, confirmNewFolder, closeModal,
    confirmRename, openMove, selectMoveTarget, confirmMove,
    downloadFile, openPreview, closePreview, onFileInputChange,
    submitKey, toggleKeyVis };
})();
</script>
</body>
</html>
